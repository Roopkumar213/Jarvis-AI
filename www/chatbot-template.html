<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Clone - AI Assistant</title>
    <link rel="stylesheet" href="chatbot-style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-robot"></i> AI Chat</h2>
                <button id="newChatBtn" class="new-chat-btn">
                    <i class="fas fa-plus"></i> New Chat
                </button>
            </div>
            
            <div class="api-section">
                <h3>API Keys</h3>
                <button id="createApiBtn" class="new-chat-btn" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-key"></i> Create API Key
                </button>
                <div id="apiKeysList" class="api-list">
                    <!-- API keys will be loaded here -->
                </div>
            </div>
            
            <div class="chat-history">
                <h3>Chat History 
                    <button id="downloadBtn" class="download-btn" title="Download Current Chat">
                        <i class="fas fa-download"></i>
                    </button>
                    <button id="clearHistoryBtn" class="clear-btn">Clear All</button>
                </h3>
                <div id="chatHistoryList" class="chat-list">
                    <!-- Chat history will be loaded here -->
                </div>
            </div>
            
            <!-- Download Modal -->
            <div id="downloadModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>Download Current Chat</h3>
                    <p>Choose the format to download your current conversation:</p>
                    <div class="download-options">
                        <button id="downloadPdf" class="download-option-btn">
                            <i class="fas fa-file-pdf"></i>
                            Download as PDF
                        </button>
                        <button id="downloadDocx" class="download-option-btn">
                            <i class="fas fa-file-word"></i>
                            Download as DOCX
                        </button>
                    </div>
                    <button id="closeDownloadModal" class="close-btn" style="margin-top: 15px;">Cancel</button>
                </div>
            </div>
            

        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <div class="chat-header">
                <h1>AI Assistant</h1>
             
                <div class="header-right">
                    <div class="voice-controls">
                        <select id="voiceSelect" class="voice-select">
                            <option value="Microsoft David English (United States)">ðŸ‘¨ Microsoft David (US)</option>
                            <option value="Microsoft Mark English (United States)">ðŸ‘¨ Microsoft Mark (US)</option>
                            <option value="Microsoft Ravi English (India)">ðŸ‘¨ Microsoft Ravi (India)</option>
                            <option value="Google UK English Male">ðŸ‘¨ Google UK Male</option>
                            <option value="Microsoft Zira English (United States)">ðŸ‘© Microsoft Zira (US)</option>
                            <option value="Microsoft Heera English (India)">ðŸ‘© Microsoft Heera (India)</option>
                            <option value="Google UK English Female">ðŸ‘© Google UK Female</option>
                        </select>
                        <button id="speedBtn" class="speed-btn" title="Speech Speed: Normal">
                            <i class="fas fa-tachometer-alt"></i>
                        </button>
                    </div>
                    <div class="model-display" id="modelDisplay">Auto</div>
                    <div class="status-indicator">
                        <span id="statusText">Ready</span>
                        <div class="status-dot" id="statusDot"></div>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-message">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h2>Welcome to AI Assistant</h2>
                    <p>Ask me anything or upload a file to analyze!</p>
                    <div class="example-prompts">
                        <button class="example-btn" onclick="sendExample('Explain quantum computing')">
                            Explain quantum computing
                        </button>
                        <button class="example-btn" onclick="sendExample('Write a Python function')">
                            Write a Python function
                        </button>
                        <button class="example-btn" onclick="sendExample('Summarize this document')">
                            Summarize this document
                        </button>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="file-preview" id="filePreview" style="display: none;">
                    <div class="file-info">
                        <i class="fas fa-file"></i>
                        <span id="fileName"></span>
                        <button id="removeFile" class="remove-btn">Ã—</button>
                    </div>
                </div>
                
                <div class="input-wrapper">
                    <button id="settingsBtn" class="settings-btn" title="AI Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button id="attachBtn" class="attach-btn" title="Upload File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button id="voiceBtn" class="voice-btn" title="Voice Input" onclick="useJarvisVoice()">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div class="input-container-wrapper">
                        <textarea id="messageInput" placeholder="Type your message..." rows="1"></textarea>
                        <div id="autoCompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    <button id="sendBtn" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <div id="settingsPopup" class="settings-popup" style="display: none;">
                    <div class="popup-content">
                        <h4>AI Model</h4>
                        <select id="modelSelect">
                            <option value="auto|">Auto (Best Available)</option>
                            <option value="groq|llama-3.1-8b-instant">Groq: Llama 3.1 8B</option>
                            <option value="groq|llama-3.3-70b-versatile">Groq: Llama 3.3 70B</option>
                            <option value="groq|qwen/qwen3-32b">Groq: Qwen 3 32B</option>
                            <option value="gemini|gemini-2.0-flash">Gemini: 2.0 Flash</option>
                            <option value="gemini|gemini-1.5-pro">Gemini: 1.5 Pro</option>
                            <option value="local|Llama-3.2-1B-Instruct-Q4_0.gguf">Local: Llama 3.2 1B</option>
                        </select>
                        <button id="closeSettings" class="close-btn">Close</button>
                    </div>
                </div>
                
                <div id="apiPopup" class="settings-popup" style="display: none;">
                    <div class="popup-content">
                        <h4>Create API Key</h4>
                        <input type="text" id="apiKeyName" placeholder="API Key Name" style="width: 100%; margin-bottom: 10px; padding: 8px;">
                        <select id="apiModelSelect" style="width: 100%; margin-bottom: 10px; padding: 8px;">
                            <option value="groq/llama-3.1-8b-instant">Groq: Llama 3.1 8B</option>
                            <option value="groq/llama-3.3-70b-versatile">Groq: Llama 3.3 70B</option>
                            <option value="groq/qwen/qwen3-32b">Groq: Qwen 3 32B</option>
                            <option value="gemini/gemini-2.0-flash">Gemini: 2.0 Flash</option>
                            <option value="gemini/gemini-1.5-pro">Gemini: 1.5 Pro</option>
                            <option value="local/Llama-3.2-1B-Instruct-Q4_0.gguf">Local: Llama 3.2 1B</option>
                        </select>
                        <button id="generateApiKey" class="new-chat-btn" style="margin-right: 10px;">Generate Key</button>
                        <button id="closeApiPopup" class="close-btn">Close</button>
                    </div>
                </div>
                <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.png,.jpg,.jpeg,.gif" hidden>
                
                <div id="apiKeyModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <h3>API Key Generated!</h3>
                        <p>Your API key has been created. Copy it now - you won't see it again!</p>
                        <div class="api-key-display">
                            <input type="text" id="generatedApiKey" readonly style="width: 100%; padding: 10px; margin: 10px 0; font-family: monospace;">
                            <button onclick="copyApiKey()" class="copy-btn">Copy Key</button>
                        </div>
                        <p><strong>Usage:</strong></p>
                        <code>curl -H "Authorization: Bearer YOUR_KEY" http://localhost:5000/api/chat/completions</code>
                        <button onclick="closeApiKeyModal()" class="close-btn" style="margin-top: 15px;">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/eel.js"></script>
    <script src="chatbot-script.js"></script>
    <script>
        window.isListening = false;
        let isListening = false;
        
        // Voice selection handler - wait for page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('voiceSelect').addEventListener('change', function(e) {
                console.log('Voice selected:', e.target.value);
                if (window.chatApp && typeof chatApp.selectVoice === 'function') {
                    chatApp.selectVoice(e.target.value);
                } else {
                    console.log('chatApp not ready yet');
                }
            });
        });
        
        async function useJarvisVoice() {
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (isListening) {
                resetVoiceButton();
                return;
            }
            
            startContinuousListening();
        }
        
        async function startContinuousListening() {
            // Activate continuous listening
            isListening = true;
            window.isListening = true;
            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            voiceBtn.title = 'Stop Listening';
            voiceBtn.style.setProperty('background', '#ff4444', 'important');
            voiceBtn.style.setProperty('color', 'white', 'important');
            voiceBtn.classList.add('listening');
            document.getElementById('statusText').textContent = 'Continuous listening active';
            document.getElementById('statusDot').style.background = '#ffa500';
            
            console.log('Continuous listening activated');
            listenOnce();
        }
        
        async function listenOnce() {
            if (!isListening) {
                console.log('Stopping listen cycle - mic not active');
                return;
            }
            
            // Don't listen while speaking or just finished speaking
            if (window.chatApp && window.chatApp.synthesis && window.chatApp.synthesis.speaking) {
                console.log('Skipping listen - currently speaking');
                setTimeout(() => listenOnce(), 3000);
                return;
            }
            
            // Add delay after speech ends to avoid picking up echo
            if (window.lastSpeechEnd && (Date.now() - window.lastSpeechEnd) < 3000) {
                console.log('Skipping listen - speech just ended');
                setTimeout(() => listenOnce(), 2000);
                return;
            }
            
            try {
                
                // Call JARVIS voice recognition with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                
                console.log('Calling voice endpoint...');
                const response = await fetch('http://localhost:8001/chatbot_listen', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    signal: controller.signal
                });
                console.log('Voice response received:', response.status);
                
                clearTimeout(timeoutId);
                const result = await response.text();
                
                if (result && result.trim() && result !== '""' && result !== 'null' && result !== 'Error:') {
                    // Clean the result
                    const cleanResult = result.replace(/^"|"$/g, '').trim();
                    if (cleanResult && cleanResult.length > 0) {
                        document.getElementById('messageInput').value = cleanResult;
                        document.getElementById('statusText').textContent = 'Voice captured!';
                        document.getElementById('statusDot').style.background = '#10a37f';
                        
                        // Auto-send the message and reset mic
                        setTimeout(() => {
                            const sendBtn = document.getElementById('sendBtn');
                            if (sendBtn) {
                                sendBtn.click();
                            } else if (window.chatApp && typeof chatApp.sendMessage === 'function') {
                                chatApp.sendMessage();
                            } else {
                                // Fallback: trigger enter key
                                const event = new KeyboardEvent('keydown', {
                                    key: 'Enter',
                                    code: 'Enter',
                                    keyCode: 13,
                                    which: 13
                                });
                                document.getElementById('messageInput').dispatchEvent(event);
                            }
                            // Don't reset mic - keep listening
                        }, 300);
                    } else {
                        document.getElementById('statusText').textContent = 'No speech detected';
                        document.getElementById('statusDot').style.background = '#ff4444';
                    }
                } else {
                    // Only show "No speech detected" if mic is still active
                    if (isListening) {
                        document.getElementById('statusText').textContent = 'No speech detected';
                        document.getElementById('statusDot').style.background = '#ff4444';
                    }
                }
                
                // Continue listening after processing
                if (isListening) {
                    setTimeout(() => listenOnce(), 2000);
                }
                
            } catch (error) {
                console.error('Voice error:', error);
                if (error.name === 'AbortError') {
                    document.getElementById('statusText').textContent = 'Voice timeout';
                } else if (error.message.includes('Failed to fetch')) {
                    document.getElementById('statusText').textContent = 'JARVIS not running';
                    resetVoiceButton();
                    return;
                } else {
                    document.getElementById('statusText').textContent = 'Voice failed';
                }
                document.getElementById('statusDot').style.background = '#ff4444';
                if (isListening) {
                    setTimeout(() => listenOnce(), 3000);
                } else {
                    console.log('Stopping listen cycle due to error - mic deactivated');
                }
            }
        }
        
        function resetVoiceButton() {
            isListening = false;
            window.isListening = false;
            
            // Stop any current speech immediately
            if (window.chatApp && window.chatApp.synthesis) {
                window.chatApp.synthesis.cancel();
                console.log('Speech cancelled - mic turned off');
            }
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            const voiceBtn = document.getElementById('voiceBtn');
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceBtn.title = 'Voice Input';
            voiceBtn.style.removeProperty('background');
            voiceBtn.style.removeProperty('color');
            voiceBtn.classList.remove('listening');
            document.getElementById('statusText').textContent = 'Ready';
            document.getElementById('statusDot').style.background = '#10a37f';
            console.log('Microphone deactivated - speech stopped');
        }
    </script>
    <style>
        .api-section { margin-top: 20px; }
        .api-list { max-height: 200px; overflow-y: auto; }
        .api-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; }
        .api-item .api-name { font-weight: bold; }
        .api-item .api-model { color: #666; }
        .api-item .api-key { font-family: monospace; color: #999; }
        .api-item button { float: right; font-size: 10px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; }
        .api-key-display { background: #f5f5f5; padding: 10px; border-radius: 5px; }
        .download-btn { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 5px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 5px;
            font-size: 12px;
        }
        .download-btn:hover { background: #2980b9; }
        .download-options { 
            display: flex; 
            gap: 15px; 
            margin: 20px 0; 
            justify-content: center;
        }
        .download-option-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        .download-option-btn:hover { background: #219a52; }
        .download-option-btn i { font-size: 18px; }
        .listening {
            background: #ff4444 !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
    <script>
        // API Key Management
        document.getElementById('createApiBtn').onclick = () => {
            document.getElementById('apiPopup').style.display = 'block';
        };
        
        document.getElementById('closeApiPopup').onclick = () => {
            document.getElementById('apiPopup').style.display = 'none';
        };
        
        document.getElementById('generateApiKey').onclick = async () => {
            const name = document.getElementById('apiKeyName').value || 'Unnamed Key';
            const model = document.getElementById('apiModelSelect').value;
            
            try {
                const response = await fetch('/create-api-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, model})
                });
                
                const result = await response.json();
                if (result.api_key) {
                    document.getElementById('generatedApiKey').value = result.api_key;
                    document.getElementById('apiPopup').style.display = 'none';
                    document.getElementById('apiKeyModal').style.display = 'block';
                    loadApiKeys();
                }
            } catch (error) {
                alert('Failed to create API key');
            }
        };
        
        function copyApiKey() {
            const keyInput = document.getElementById('generatedApiKey');
            keyInput.select();
            document.execCommand('copy');
            alert('API key copied to clipboard!');
        }
        
        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }
        
        async function loadApiKeys() {
            try {
                const response = await fetch('/list-api-keys');
                const data = await response.json();
                const apiList = document.getElementById('apiKeysList');
                
                apiList.innerHTML = data.api_keys.map(key => `
                    <div class="api-item">
                        <div class="api-name">${key.name}</div>
                        <div class="api-model">${key.model}</div>
                        <div class="api-key">${key.key}</div>
                        <button onclick="deleteApiKey('${key.full_key}')">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load API keys:', error);
            }
        }
        
        async function deleteApiKey(apiKey) {
            if (confirm('Delete this API key?')) {
                try {
                    await fetch('/delete-api-key', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({api_key: apiKey})
                    });
                    loadApiKeys();
                } catch (error) {
                    alert('Failed to delete API key');
                }
            }
        }
        
        // Load API keys on page load
        loadApiKeys();
        
        // Download functionality
        let currentChatId = null;
        
        document.getElementById('downloadBtn').onclick = () => {
            const messages = getCurrentChatMessages();
            if (messages.length === 0) {
                alert('No messages to export. Start a conversation first.');
                return;
            }
            document.getElementById('downloadModal').style.display = 'block';
        };
        
        document.getElementById('closeDownloadModal').onclick = () => {
            document.getElementById('downloadModal').style.display = 'none';
        };
        
        document.getElementById('downloadPdf').onclick = () => {
            downloadCurrentChat('pdf');
        };
        
        document.getElementById('downloadDocx').onclick = () => {
            downloadCurrentChat('docx');
        };
        
        function getCurrentChatMessages() {
            const messages = [];
            const messageElements = document.querySelectorAll('.message');
            let userMessage = '';
            
            messageElements.forEach(msg => {
                let content = '';
                const messageContent = msg.querySelector('.message-content');
                
                if (messageContent) {
                    // Clone the content to process
                    const clone = messageContent.cloneNode(true);
                    
                    // Find and replace code blocks
                    const codeBlocks = clone.querySelectorAll('.code-block');
                    codeBlocks.forEach(block => {
                        const codeElement = block.querySelector('code');
                        if (codeElement) {
                            const code = codeElement.textContent;
                            const language = block.dataset.language || 'code';
                            
                            // Create formatted code block
                            const codeDiv = document.createElement('div');
                            codeDiv.textContent = `\n\n--- ${language.toUpperCase()} CODE ---\n${code}\n--- END CODE ---\n\n`;
                            block.parentNode.replaceChild(codeDiv, block);
                        }
                    });
                    
                    content = clone.textContent;
                }
                
                if (msg.classList.contains('user')) {
                    userMessage = content;
                } else if (msg.classList.contains('assistant') && userMessage) {
                    messages.push({
                        user_message: userMessage,
                        ai_response: content,
                        timestamp: new Date().toISOString()
                    });
                    userMessage = '';
                }
            });
            
            return messages;
        }
        
        async function downloadCurrentChat(format) {
            try {
                const payload = currentChatId ? 
                    {chat_id: currentChatId} : 
                    {messages: getCurrentChatMessages()};
                
                const response = await fetch(`/download-current-chat/${format}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `current_chat.${format}`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.getElementById('downloadModal').style.display = 'none';
                } else {
                    alert('Download failed');
                }
            } catch (error) {
                alert('Download error: ' + error.message);
            }
        }
        
        // Update current chat ID when loading a chat
        window.setCurrentChatId = function(chatId) {
            currentChatId = chatId;
        };
    </script>
</body>
</html>